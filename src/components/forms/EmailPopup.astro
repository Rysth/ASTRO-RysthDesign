---
import { FaWhatsapp, FaTimes, FaEnvelope } from "react-icons/fa";
---

<!-- Email Popup Modal -->
<div
  id="emailPopup"
  class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black/50 backdrop-blur-sm"
>
  <div class="relative w-full max-w-sm mx-4">
    <!-- Modal Content -->
    <div
      class="relative p-6 rounded-2xl bg-gradient-to-br from-[#1a1a2e] to-[#0a0a0a] border border-[#25D366]/20 backdrop-blur-xl"
    >
      <!-- Close Button -->
      <button
        id="closePopup"
        class="absolute p-2 text-gray-400 transition-all duration-300 rounded-full top-3 right-3 hover:text-white hover:bg-white/10"
      >
        <FaTimes className="text-sm" />
      </button>

      <!-- Header -->
      <div class="mb-5 text-center">
        <div class="flex items-center justify-center gap-2 mb-3">
          <span class="text-xl">üéÅ</span>
          <h3 class="text-lg font-bold text-yellow-400">¬°Oferta Especial!</h3>
        </div>
        <h2 class="mb-2 text-xl font-bold text-white">
          <span class="text-yellow-400">Primer Mes GRATIS</span> de ChatWoot
        </h2>
        <p class="text-xs text-gray-300">
          D√©janos tu email y te enviamos los detalles
        </p>
      </div>

      <!-- Form -->
      <form
        id="emailForm"
        name="chatwoot-offer"
        method="POST"
        data-netlify="true"
        class="space-y-4"
      >
        <!-- Hidden field for Netlify -->
        <input type="hidden" name="form-name" value="chatwoot-offer" />

        <!-- Email Field -->
        <div>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-3 rounded-lg bg-[#2d2d44]/50 border border-[#25D366]/20 text-white placeholder-gray-400 focus:border-[#25D366] focus:outline-none focus:ring-2 focus:ring-[#25D366]/20 transition-all duration-300"
            placeholder="Tu email"
          />
        </div>

        <!-- Plan Selection -->
        <div>
          <select
            id="plan"
            name="plan"
            class="w-full px-4 py-3 rounded-lg bg-[#2d2d44]/50 border border-[#25D366]/20 text-white focus:border-[#25D366] focus:outline-none focus:ring-2 focus:ring-[#25D366]/20 transition-all duration-300"
          >
            <option value="whatsapp"
              >ChatWoot WhatsApp ($460 + $25/mes) - 3 usuarios</option
            >
            <option value="completo"
              >ChatWoot Completo ($850 + $35/mes) - 5 usuarios</option
            >
            <option value="custom-users"
              >Necesito m√°s usuarios (+$5/mes por usuario adicional)</option
            >
            <option value="no-sure">No estoy seguro a√∫n</option>
          </select>
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          class="flex items-center justify-center w-full gap-2 px-6 py-3 font-semibold text-white transition-all duration-300 rounded-lg shadow-lg bg-gradient-to-r from-yellow-500 to-orange-500 hover:shadow-xl hover:scale-105"
        >
          <FaEnvelope className="text-sm" />
          <span>Recibir Oferta</span>
        </button>

        <!-- Alternative CTA -->
        <div class="text-center">
          <a
            href="https://wa.me/593988949117?text=Hola%20RysthDesign%2C%20vi%20la%20oferta%20especial%20de%20ChatWoot%20con%20el%20primer%20mes%20GRATIS%20de%20mantenimiento.%20%C2%BFPodr%C3%ADamos%20hablar%20sobre%20los%20detalles%3F"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-3 py-2 text-[#25D366] border border-[#25D366]/30 rounded-full hover:bg-[#25D366]/10 transition-all duration-300 text-xs"
          >
            <FaWhatsapp className="text-xs" />
            <span>WhatsApp directo</span>
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div
  id="successModal"
  class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black/50 backdrop-blur-sm"
>
  <div class="relative w-full max-w-sm mx-4">
    <div
      class="relative p-6 rounded-2xl bg-gradient-to-br from-[#1a1a2e] to-[#0a0a0a] border border-[#25D366]/20 backdrop-blur-xl text-center"
    >
      <div class="mb-5">
        <div class="mb-3 text-4xl">üéâ</div>
        <h3 class="text-xl font-bold text-[#25D366] mb-2">¬°Perfecto!</h3>
        <p class="text-sm text-gray-300">
          Te contactaremos pronto con todos los detalles de tu
          <span class="font-semibold text-yellow-400">primer mes GRATIS</span>.
        </p>
      </div>

      <div class="space-y-3">
        <button
          id="closeSuccess"
          class="w-full px-6 py-3 bg-gradient-to-r from-[#25D366] to-[#128C7E] rounded-lg text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105"
        >
          Continuar
        </button>

        <a
          href="https://wa.me/593988949117?text=Hola%20RysthDesign%2C%20acabo%20de%20enviar%20mi%20informaci√≥n%20para%20la%20oferta%20especial%20de%20ChatWoot.%20%C2%BFCu%C3%A1ndo%20podemos%20hablar%3F"
          target="_blank"
          rel="noopener noreferrer"
          class="w-full inline-flex items-center justify-center gap-2 px-6 py-3 text-[#25D366] border border-[#25D366]/30 rounded-lg hover:bg-[#25D366]/10 transition-all duration-300 text-sm"
        >
          <FaWhatsapp className="text-sm" />
          <span>WhatsApp ahora</span>
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  // Email popup functionality
  document.addEventListener("DOMContentLoaded", function () {
    const emailPopup = document.getElementById("emailPopup");
    const successModal = document.getElementById("successModal");
    const closePopup = document.getElementById("closePopup");
    const closeSuccess = document.getElementById("closeSuccess");
    const emailForm = document.getElementById("emailForm");

    // Show popup after 30 seconds or when user scrolls 70%
    let popupShown = false;

    function showPopup() {
      if (!popupShown) {
        emailPopup.classList.remove("hidden");
        popupShown = true;
        localStorage.setItem("emailPopupShown", Date.now().toString());
      }
    }

    // Check if popup was shown in last 24 hours
    const lastShown = localStorage.getItem("emailPopupShown");
    if (!lastShown || Date.now() - parseInt(lastShown) > 86400000) {
      // Show after 30 seconds
      setTimeout(showPopup, 10000);

      // Or when user scrolls 70%
      window.addEventListener("scroll", function () {
        const scrollPercent =
          (window.scrollY /
            (document.documentElement.scrollHeight - window.innerHeight)) *
          100;
        if (scrollPercent > 70) {
          showPopup();
        }
      });
    }

    // Close popup
    closePopup.addEventListener("click", function () {
      emailPopup.classList.add("hidden");
    });

    // Close success modal
    closeSuccess.addEventListener("click", function () {
      successModal.classList.add("hidden");
    });

    // Click outside to close
    emailPopup.addEventListener("click", function (e) {
      if (e.target === emailPopup) {
        emailPopup.classList.add("hidden");
      }
    });

    successModal.addEventListener("click", function (e) {
      if (e.target === successModal) {
        successModal.classList.add("hidden");
      }
    });

    // Handle form submission with AJAX
    const handleSubmit = (event) => {
      event.preventDefault();

      const myForm = event.target;
      const formData = new FormData(myForm);

      // Show loading state
      const submitBtn = myForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML =
        '<span class="inline-block w-4 h-4 mr-2 border-2 border-white rounded-full animate-spin border-t-transparent"></span>Enviando...';
      submitBtn.disabled = true;

      fetch("/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(formData).toString(),
      })
        .then(() => {
          // Hide email popup
          emailPopup.classList.add("hidden");

          // Show success modal
          successModal.classList.remove("hidden");

          // Reset form
          myForm.reset();

          // Track successful submission
          console.log("Email successfully captured for ChatWoot offer");

          // Optional: Send analytics event
          if (typeof gtag !== "undefined") {
            gtag("event", "email_capture", {
              event_category: "chatwoot_offer",
              event_label: "special_offer_popup",
            });
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert(
            "Hubo un error al enviar el formulario. Por favor, intenta nuevamente o cont√°ctanos por WhatsApp.",
          );
        })
        .finally(() => {
          // Reset button
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
    };

    emailForm.addEventListener("submit", handleSubmit);
  });
</script>

<style>
  /* Smooth animations */
  #emailPopup,
  #successModal {
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Form focus styles */
  input:focus,
  select:focus {
    transform: translateY(-1px);
  }

  /* Custom scrollbar for select */
  select {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2325D366' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
  }
</style>
